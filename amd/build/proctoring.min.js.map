{"version":3,"file":"proctoring.min.js","sources":["../src/proctoring.js"],"sourcesContent":["import $ from 'jquery';\nimport Ajax from 'core/ajax';\n\nexport const webcam_proctoring = (props) => {\n    let isCameraAllowed = false;\n\n    $(() => {\n        $('#id_submitbutton').prop(\"disabled\", true);\n        $('#id_proctoring').on('change', function() {\n            if (this.checked && isCameraAllowed) {\n                $('#id_submitbutton').prop(\"disabled\", false);\n            } else {\n                $('#id_submitbutton').prop(\"disabled\", true);\n            }\n        });\n    });\n\n    let width = props.image_width; // We will scale the photo width to this\n    let height = 0; // This will be computed based on the input stream\n\n    let streaming = false;\n\n    // const firstcalldelay = 3000; // 3 seconds after the page load\n    const takepicturedelay = props.frequency;\n\n    if (props.is_quiz_started) {\n        // eslint-disable-next-line max-len\n        $('#mod_quiz_navblock').append('<div class=\"card-body p-3\"><h3 class=\"no text-left\">Webcam</h3> <br/>' + '<video id=\"video\">Video stream not available.</video><canvas id=\"canvas\" style=\"display:none;\"></canvas>' + '<div class=\"output\" style=\"display:none;\">' + '<img id=\"photo\" alt=\"The picture will appear in this box.\"/></div></div>');\n    }\n\n    let video = document.getElementById('video');\n    let canvas = document.getElementById('canvas');\n    let photo = document.getElementById('photo');\n\n    navigator.mediaDevices\n        .getUserMedia({video: true, audio: false})\n        .then((stream) => {\n            video.srcObject = stream;\n            video.play();\n            isCameraAllowed = true;\n        })\n        .catch((err) => {\n            window.console.error(`An error occurred: ${err}`);\n        });\n\n    const clearphoto = () => {\n        const context = canvas.getContext(\"2d\");\n        context.fillStyle = \"#AAA\";\n        context.fillRect(0, 0, canvas.width, canvas.height);\n\n        const data = canvas.toDataURL(\"image/png\");\n        photo.setAttribute(\"src\", data);\n    };\n\n    const takepicture = () => {\n        if (props.is_quiz_started) {\n            const context = canvas.getContext(\"2d\");\n            if (width && height) {\n                canvas.width = width;\n                canvas.height = height;\n                context.drawImage(video, 0, 0, width, height);\n\n                const data = canvas.toDataURL(\"image/png\");\n                photo.setAttribute(\"src\", data);\n                props.webcampicture = data;\n\n                const api_function = 'quizaccess_exproctor_send_webcam_shot';\n                const params = {\n                    'courseid': props.courseid,\n                    'webcamshotid': props.id,\n                    'quizid': props.quizid,\n                    'webcampicture': data,\n                };\n\n                const request = {\n                    methodname: api_function,\n                    args: params\n                };\n\n                window.console.log(params);\n\n                // window.console.log(Ajax.call([request]));\n\n                Ajax.call([request])[0].done((data) => {\n                    window.console.log(data);\n                    if (data.warnings.length !== 0) {\n                        if (video) {\n                            Notification.addNotification({\n                                message: 'Something went wrong during taking the image.', type: 'error'\n                            });\n                        }\n                    }\n                }).fail(Notification.exception);\n            } else {\n                clearphoto();\n            }\n        }\n    };\n\n    if (video) {\n        video.addEventListener(\n            \"canplay\",\n            () => {\n                if (!streaming) {\n                    if (props.is_quiz_started) {\n                        width = 270;\n                    } else {\n                        width = 320;\n                    }\n                    height = video.videoHeight / (video.videoWidth / width);\n\n                    if (isNaN(height)) {\n                        height = width / (4 / 3);\n                    }\n\n                    video.setAttribute(\"width\", width);\n                    video.setAttribute(\"height\", height);\n                    canvas.setAttribute(\"width\", width);\n                    canvas.setAttribute(\"height\", height);\n                    streaming = true;\n                }\n            },\n            false\n        );\n        if (props.is_quiz_started) {\n            // setTimeout(takepicture, firstcalldelay);\n            setInterval(takepicture, takepicturedelay);\n        }\n\n        window.console.log(props);\n    }\n};"],"names":["props","isCameraAllowed","prop","on","this","checked","width","image_width","height","streaming","takepicturedelay","frequency","is_quiz_started","append","video","document","getElementById","canvas","photo","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","err","window","console","error","takepicture","context","getContext","drawImage","data","toDataURL","setAttribute","webcampicture","api_function","params","courseid","id","quizid","request","methodname","args","log","call","done","warnings","length","Notification","addNotification","message","type","fail","exception","fillStyle","fillRect","clearphoto","addEventListener","videoHeight","videoWidth","isNaN","setInterval"],"mappings":"+XAGkCA,YAC1BC,iBAAkB,uBAEpB,yBACI,oBAAoBC,KAAK,YAAY,uBACrC,kBAAkBC,GAAG,UAAU,WACzBC,KAAKC,SAAWJ,oCACd,oBAAoBC,KAAK,YAAY,uBAErC,oBAAoBA,KAAK,YAAY,aAK/CI,MAAQN,MAAMO,YACdC,OAAS,EAETC,WAAY,QAGVC,iBAAmBV,MAAMW,UAE3BX,MAAMY,qCAEJ,sBAAsBC,OAAO,uSAG/BC,MAAQC,SAASC,eAAe,SAChCC,OAASF,SAASC,eAAe,UACjCE,MAAQH,SAASC,eAAe,SAEpCG,UAAUC,aACLC,aAAa,CAACP,OAAO,EAAMQ,OAAO,IAClCC,MAAMC,SACHV,MAAMW,UAAYD,OAClBV,MAAMY,OACNzB,iBAAkB,CAAlB,IAEH0B,OAAOC,MACJC,OAAOC,QAAQC,mCAA4BH,eAY7CI,YAAc,QACZhC,MAAMY,gBAAiB,OACjBqB,QAAUhB,OAAOiB,WAAW,SAC9B5B,OAASE,OAAQ,CACjBS,OAAOX,MAAQA,MACfW,OAAOT,OAASA,OAChByB,QAAQE,UAAUrB,MAAO,EAAG,EAAGR,MAAOE,cAEhC4B,KAAOnB,OAAOoB,UAAU,aAC9BnB,MAAMoB,aAAa,MAAOF,MAC1BpC,MAAMuC,cAAgBH,WAEhBI,aAAe,wCACfC,OAAS,UACCzC,MAAM0C,sBACF1C,MAAM2C,UACZ3C,MAAM4C,qBACCR,MAGfS,QAAU,CACZC,WAAYN,aACZO,KAAMN,QAGVZ,OAAOC,QAAQkB,IAAIP,sBAIdQ,KAAK,CAACJ,UAAU,GAAGK,MAAMd,OAC1BP,OAAOC,QAAQkB,IAAIZ,MACU,IAAzBA,KAAKe,SAASC,QACVtC,OACAuC,aAAaC,gBAAgB,CACzBC,QAAS,gDAAiDC,KAAM,aAI7EC,KAAKJ,aAAaK,eA/Cd,YACTzB,QAAUhB,OAAOiB,WAAW,MAClCD,QAAQ0B,UAAY,OACpB1B,QAAQ2B,SAAS,EAAG,EAAG3C,OAAOX,MAAOW,OAAOT,cAEtC4B,KAAOnB,OAAOoB,UAAU,aAC9BnB,MAAMoB,aAAa,MAAOF,OA2ClByB,KAKR/C,QACAA,MAAMgD,iBACF,WACA,KACSrD,YAEGH,MADAN,MAAMY,gBACE,IAEA,IAEZJ,OAASM,MAAMiD,aAAejD,MAAMkD,WAAa1D,OAE7C2D,MAAMzD,UACNA,OAASF,OAAS,EAAI,IAG1BQ,MAAMwB,aAAa,QAAShC,OAC5BQ,MAAMwB,aAAa,SAAU9B,QAC7BS,OAAOqB,aAAa,QAAShC,OAC7BW,OAAOqB,aAAa,SAAU9B,QAC9BC,WAAY,MAGpB,GAEAT,MAAMY,iBAENsD,YAAYlC,YAAatB,kBAG7BmB,OAAOC,QAAQkB,IAAIhD"}