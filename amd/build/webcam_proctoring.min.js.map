{"version":3,"file":"webcam_proctoring.min.js","sources":["../src/webcam_proctoring.js"],"sourcesContent":["import $ from \"jquery\";\nimport Ajax from \"core/ajax\";\nimport { remove } from \"./store_current_attempt\";\n\nexport const init = (props) => {\n  let isCameraAllowed = false;\n\n  $(\"#id_submitbutton\").prop(\"disabled\", true);\n  $(\"#id_webproctoring\").on(\"change\", function () {\n    if (this.checked && isCameraAllowed) {\n      $(\"#id_submitbutton\").prop(\"disabled\", false);\n    } else {\n      $(\"#id_submitbutton\").prop(\"disabled\", true);\n    }\n  });\n\n  // Skip for summary page\n  if (\n    document.getElementById(\"page-mod-quiz-summary\") !== null &&\n    document.getElementById(\"page-mod-quiz-summary\").innerHTML.length\n  ) {\n    return false;\n  }\n\n  // Skip for review page\n  if (\n    document.getElementById(\"page-mod-quiz-review\") !== null &&\n    document.getElementById(\"page-mod-quiz-review\").innerHTML.length\n  ) {\n    props.is_quiz_started = false;\n    remove();\n    return false;\n  }\n\n  let width = props.image_width; // We will scale the photo width to this\n  let height = 0; // This will be computed based on the input stream\n\n  let streaming = false;\n\n  if (props.is_quiz_started) {\n    // eslint-disable-next-line max-len\n    $(\"#mod_quiz_navblock\").append(\n      '<div class=\"card-body p-3\"><h3 class=\"no text-left\">Webcam</h3> <br/>' +\n        '<video id=\"exproctor_video_wb\">Video stream not available.</video>' +\n        '<canvas id=\"exproctor_canvas_wb\" style=\"display:none;\"></canvas>' +\n        '<div class=\"exproctor_output_wb\" style=\"display:none;\">' +\n        '<img id=\"exproctor_photo_wb\" alt=\"The webcam capture will appear in this box.\"/></div></div>'\n    );\n  }\n\n  let video = document.getElementById(\"exproctor_video_wb\");\n  let canvas = document.getElementById(\"exproctor_canvas_wb\");\n  let photo = document.getElementById(\"exproctor_photo_wb\");\n\n  const get_webcam_share_permission = () => {\n    return navigator.mediaDevices\n      .getUserMedia({ video: true, audio: false })\n      .then((stream) => {\n        video.srcObject = stream;\n        video.play();\n        isCameraAllowed = true;\n      })\n      .catch(() => {\n        alert(\"This quiz requires Webcam permission to start!\");\n        get_webcam_share_permission();\n      });\n  };\n\n  $(\"#id_submitbutton\").click(function () {\n    localStorage.removeItem(\"attemptId\");\n    localStorage.removeItem(\"bucketName\");\n    props.is_quiz_started = true;\n    takepicture();\n    setInterval(takepicture, props.proctoringmethod == 2 ? 1000 : props.screenshotdelay);\n  });\n\n  $(`#${$(\"[id^=single_button].btn.btn-primary\")[0].id}`).click(function () {\n    get_webcam_share_permission();\n    props.is_quiz_started = true;\n    takepicture();\n    setInterval(takepicture, props.proctoringmethod === 2 ? 1000 : props.screenshotdelay);\n  });\n\n  const clearphoto = () => {\n    const context = canvas.getContext(\"2d\");\n    context.fillStyle = \"#AAA\";\n    context.fillRect(0, 0, canvas.width, canvas.height);\n\n    const data = canvas.toDataURL(\"image/png\");\n    photo.setAttribute(\"src\", data);\n  };\n\n  const takepicture = () => {\n    props.id = localStorage.getItem(\"attemptId\");\n\n    if (props.is_quiz_started && props.id) {\n      const context = canvas.getContext(\"2d\");\n      if (width && height) {\n        canvas.width = width;\n        canvas.height = height;\n        context.drawImage(video, 0, 0, width, height);\n\n        const data = canvas.toDataURL(\"image/png\");\n        photo.setAttribute(\"src\", data);\n        props.webcampicture = data;\n\n        const api_function = \"quizaccess_exproctor_send_webcam_shot\";\n        const params = {\n          courseid: props.courseid,\n          attemptid: props.id,\n          quizid: props.quizid,\n          webcamshot: data,\n          bucketName: localStorage.getItem(\"bucketName\"),\n          aiproctoring: props.proctoringmethod == 2,\n        };\n\n        const request = {\n          methodname: api_function,\n          args: params,\n        };\n\n        window.console.log(params);\n\n        Ajax.call([request])[0]\n          .done((data) => {\n            window.console.log(data);\n            if (data.warnings.length !== 0) {\n              if (video) {\n                Notification.addNotification({\n                  message: \"Something went wrong during taking the image.\",\n                  type: \"error\",\n                });\n              }\n            }\n          })\n          .fail((err) => {\n            window.console.log(\"Webcam proctoring\");\n            window.console.log(err);\n          });\n      } else {\n        clearphoto();\n      }\n    }\n  };\n\n  if (video) {\n    video.addEventListener(\n      \"canplay\",\n      () => {\n        if (!streaming) {\n          if (props.is_quiz_started) {\n            width = 270;\n          }\n          height = video.videoHeight / (video.videoWidth / width);\n\n          if (isNaN(height)) {\n            height = width / (4 / 3);\n          }\n\n          video.setAttribute(\"width\", width);\n          video.setAttribute(\"height\", height);\n          canvas.setAttribute(\"width\", width);\n          canvas.setAttribute(\"height\", height);\n          streaming = true;\n        }\n      },\n      false\n    );\n  }\n};\n"],"names":["props","isCameraAllowed","prop","on","this","checked","document","getElementById","innerHTML","length","is_quiz_started","width","image_width","height","streaming","append","video","canvas","photo","get_webcam_share_permission","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","alert","click","localStorage","removeItem","takepicture","setInterval","proctoringmethod","screenshotdelay","id","getItem","context","getContext","drawImage","data","toDataURL","setAttribute","webcampicture","api_function","params","courseid","attemptid","quizid","webcamshot","bucketName","aiproctoring","request","methodname","args","window","console","log","call","done","warnings","Notification","addNotification","message","type","fail","err","fillStyle","fillRect","clearphoto","addEventListener","videoHeight","videoWidth","isNaN"],"mappings":"6ZAIqBA,YACfC,iBAAkB,yBAEpB,oBAAoBC,KAAK,YAAY,uBACrC,qBAAqBC,GAAG,UAAU,WAC9BC,KAAKC,SAAWJ,oCAChB,oBAAoBC,KAAK,YAAY,uBAErC,oBAAoBA,KAAK,YAAY,MAMY,OAArDI,SAASC,eAAe,0BACxBD,SAASC,eAAe,yBAAyBC,UAAUC,cAEpD,KAK6C,OAApDH,SAASC,eAAe,yBACxBD,SAASC,eAAe,wBAAwBC,UAAUC,cAE1DT,MAAMU,iBAAkB,uCAEjB,MAGLC,MAAQX,MAAMY,YACdC,OAAS,EAETC,WAAY,EAEZd,MAAMU,qCAEN,sBAAsBK,OACtB,kWAQAC,MAAQV,SAASC,eAAe,sBAChCU,OAASX,SAASC,eAAe,uBACjCW,MAAQZ,SAASC,eAAe,4BAE9BY,4BAA8B,IAC3BC,UAAUC,aACdC,aAAa,CAAEN,OAAO,EAAMO,OAAO,IACnCC,MAAMC,SACLT,MAAMU,UAAYD,OAClBT,MAAMW,OACN1B,iBAAkB,CAAlB,IAED2B,OAAM,KACLC,MAAM,kDACNV,qDAIJ,oBAAoBW,OAAM,WAC1BC,aAAaC,WAAW,aACxBD,aAAaC,WAAW,cACxBhC,MAAMU,iBAAkB,EACxBuB,cACAC,YAAYD,YAAuC,GAA1BjC,MAAMmC,iBAAwB,IAAOnC,MAAMoC,oDAGhE,mBAAE,uCAAuC,GAAGC,KAAMP,OAAM,WAC5DX,8BACAnB,MAAMU,iBAAkB,EACxBuB,cACAC,YAAYD,YAAwC,IAA3BjC,MAAMmC,iBAAyB,IAAOnC,MAAMoC,0BAYjEH,YAAc,QAClBjC,MAAMqC,GAAKN,aAAaO,QAAQ,aAE5BtC,MAAMU,iBAAmBV,MAAMqC,GAAI,OAC/BE,QAAUtB,OAAOuB,WAAW,SAC9B7B,OAASE,OAAQ,CACnBI,OAAON,MAAQA,MACfM,OAAOJ,OAASA,OAChB0B,QAAQE,UAAUzB,MAAO,EAAG,EAAGL,MAAOE,cAEhC6B,KAAOzB,OAAO0B,UAAU,aAC9BzB,MAAM0B,aAAa,MAAOF,MAC1B1C,MAAM6C,cAAgBH,WAEhBI,aAAe,wCACfC,OAAS,CACbC,SAAUhD,MAAMgD,SAChBC,UAAWjD,MAAMqC,GACjBa,OAAQlD,MAAMkD,OACdC,WAAYT,KACZU,WAAYrB,aAAaO,QAAQ,cACjCe,aAAwC,GAA1BrD,MAAMmC,kBAGhBmB,QAAU,CACdC,WAAYT,aACZU,KAAMT,QAGRU,OAAOC,QAAQC,IAAIZ,sBAEda,KAAK,CAACN,UAAU,GAClBO,MAAMnB,OACLe,OAAOC,QAAQC,IAAIjB,MACU,IAAzBA,KAAKoB,SAASrD,QACZO,OACF+C,aAAaC,gBAAgB,CAC3BC,QAAS,gDACTC,KAAM,aAKbC,MAAMC,MACLX,OAAOC,QAAQC,IAAI,qBACnBF,OAAOC,QAAQC,IAAIS,YAtDV,YACX7B,QAAUtB,OAAOuB,WAAW,MAClCD,QAAQ8B,UAAY,OACpB9B,QAAQ+B,SAAS,EAAG,EAAGrD,OAAON,MAAOM,OAAOJ,cAEtC6B,KAAOzB,OAAO0B,UAAU,aAC9BzB,MAAM0B,aAAa,MAAOF,OAmDtB6B,KAKFvD,OACFA,MAAMwD,iBACJ,WACA,KACO1D,YACCd,MAAMU,kBACRC,MAAQ,KAEVE,OAASG,MAAMyD,aAAezD,MAAM0D,WAAa/D,OAE7CgE,MAAM9D,UACRA,OAASF,OAAS,EAAI,IAGxBK,MAAM4B,aAAa,QAASjC,OAC5BK,MAAM4B,aAAa,SAAU/B,QAC7BI,OAAO2B,aAAa,QAASjC,OAC7BM,OAAO2B,aAAa,SAAU/B,QAC9BC,WAAY,MAGhB"}