{"version":3,"file":"webcam_proctoring.min.js","sources":["../src/webcam_proctoring.js"],"sourcesContent":["import $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport {remove} from \"./store_current_attempt\";\n\nexport const init = (props) => {\n    let isCameraAllowed = false;\n\n    window.console.log(props);\n\n    $('#id_submitbutton').prop(\"disabled\", true);\n    $('#id_web_proctoring').on('change', function() {\n        if (this.checked && isCameraAllowed) {\n            $('#id_submitbutton').prop(\"disabled\", false);\n        } else {\n            $('#id_submitbutton').prop(\"disabled\", true);\n        }\n    });\n\n    // Skip for summary page\n    if (document.getElementById(\"page-mod-quiz-summary\") !== null &&\n        document.getElementById(\"page-mod-quiz-summary\").innerHTML.length) {\n        return false;\n    }\n\n    // Skip for review page\n    if (document.getElementById(\"page-mod-quiz-review\") !== null &&\n        document.getElementById(\"page-mod-quiz-review\").innerHTML.length) {\n        $(Ajax).call({\n            methodname: \"set_wb_quiz_status\",\n            args: {\n                'courseid': props.courseid,\n                'userid': props.userid,\n                'quizid': props.quizid\n            }\n        });\n        props.is_quiz_started = false;\n        remove();\n        return false;\n    }\n\n    let width = props.image_width; // We will scale the photo width to this\n    let height = 0; // This will be computed based on the input stream\n\n    let streaming = false;\n\n    if (props.is_quiz_started) {\n        // eslint-disable-next-line max-len\n        $('#mod_quiz_navblock').append(\n            '<div class=\"card-body p-3\"><h3 class=\"no text-left\">Webcam</h3> <br/>' +\n            '<video id=\"exproctor_video_wb\">Video stream not available.</video>' +\n            '<canvas id=\"exproctor_canvas_wb\" style=\"display:none;\"></canvas>' +\n            '<div class=\"exproctor_output_wb\" style=\"display:none;\">' +\n            '<img id=\"exproctor_photo_wb\" alt=\"The webcam capture will appear in this box.\"/></div></div>'\n        );\n    }\n\n    let video = document.getElementById('exproctor_video_wb');\n    let canvas = document.getElementById('exproctor_canvas_wb');\n    let photo = document.getElementById('exproctor_photo_wb');\n\n    $(\"#id_submitbutton\").click(function() {\n        props.is_quiz_started = true;\n        setInterval(takepicture, props.screenshotdelay);\n    });\n\n    navigator.mediaDevices\n        .getUserMedia({video: true, audio: false})\n        .then((stream) => {\n            video.srcObject = stream;\n            video.play();\n            isCameraAllowed = true;\n        })\n        .catch((err) => {\n            window.console.error(`An error occurred: ${err}`);\n        });\n\n    const clearphoto = () => {\n        const context = canvas.getContext(\"2d\");\n        context.fillStyle = \"#AAA\";\n        context.fillRect(0, 0, canvas.width, canvas.height);\n\n        const data = canvas.toDataURL(\"image/png\");\n        photo.setAttribute(\"src\", data);\n    };\n\n    const takepicture = () => {\n        props.id = localStorage.getItem(\"attemptId\");\n\n        if (props.is_quiz_started && props.id) {\n            const context = canvas.getContext(\"2d\");\n            if (width && height) {\n                canvas.width = width;\n                canvas.height = height;\n                context.drawImage(video, 0, 0, width, height);\n\n                const data = canvas.toDataURL(\"image/png\");\n                photo.setAttribute(\"src\", data);\n                props.webcampicture = data;\n\n                const api_function = 'quizaccess_exproctor_send_webcam_shot';\n                const params = {\n                    'courseid': props.courseid,\n                    'attemptid': props.id,\n                    'quizid': props.quizid,\n                    'webcamshot': data,\n                };\n\n                const request = {\n                    methodname: api_function,\n                    args: params\n                };\n\n                window.console.log(params);\n\n                Ajax.call([request])[0].done((data) => {\n                    window.console.log(data);\n                    if (data.warnings.length !== 0) {\n                        if (video) {\n                            Notification.addNotification({\n                                message: 'Something went wrong during taking the image.', type: 'error'\n                            });\n                        }\n                    }\n                }).fail((err) => {\n                    window.console.log(\"Webcam proctoring\");\n                    window.console.log(err);\n                });\n            } else {\n                clearphoto();\n            }\n        }\n    };\n\n    if (video) {\n        video.addEventListener(\n            \"canplay\",\n            () => {\n                if (!streaming) {\n                    if (props.is_quiz_started) {\n                        width = 270;\n                    }\n                    height = video.videoHeight / (video.videoWidth / width);\n\n                    if (isNaN(height)) {\n                        height = width / (4 / 3);\n                    }\n\n                    video.setAttribute(\"width\", width);\n                    video.setAttribute(\"height\", height);\n                    canvas.setAttribute(\"width\", width);\n                    canvas.setAttribute(\"height\", height);\n                    streaming = true;\n                }\n            },\n            false\n        );\n    }\n\n    // const vidOff = () => {\n    //     video.srcObject.getVideoTracks().forEach((track) => track.stop());\n    //     isCameraAllowed = false;\n    // };\n    //\n    // if (props.is_close) {\n    //     vidOff();\n    //     return false;\n    // }\n};"],"names":["props","isCameraAllowed","window","console","log","prop","on","this","checked","document","getElementById","innerHTML","length","Ajax","call","methodname","args","courseid","userid","quizid","is_quiz_started","width","image_width","height","streaming","append","video","canvas","photo","click","setInterval","takepicture","screenshotdelay","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","err","error","id","localStorage","getItem","context","getContext","drawImage","data","toDataURL","setAttribute","webcampicture","api_function","params","request","done","warnings","Notification","addNotification","message","type","fail","fillStyle","fillRect","clearphoto","addEventListener","videoHeight","videoWidth","isNaN"],"mappings":"6ZAIqBA,YACbC,iBAAkB,KAEtBC,OAAOC,QAAQC,IAAIJ,2BAEjB,oBAAoBK,KAAK,YAAY,uBACrC,sBAAsBC,GAAG,UAAU,WAC7BC,KAAKC,SAAWP,oCACd,oBAAoBI,KAAK,YAAY,uBAErC,oBAAoBA,KAAK,YAAY,MAKU,OAArDI,SAASC,eAAe,0BACxBD,SAASC,eAAe,yBAAyBC,UAAUC,cACpD,KAI6C,OAApDH,SAASC,eAAe,yBACxBD,SAASC,eAAe,wBAAwBC,UAAUC,iCACxDC,eAAMC,KAAK,CACTC,WAAY,qBACZC,KAAM,UACUhB,MAAMiB,gBACRjB,MAAMkB,cACNlB,MAAMmB,UAGxBnB,MAAMoB,iBAAkB,uCAEjB,MAGPC,MAAQrB,MAAMsB,YACdC,OAAS,EAETC,WAAY,EAEZxB,MAAMoB,qCAEJ,sBAAsBK,OACpB,kWAQJC,MAAQjB,SAASC,eAAe,sBAChCiB,OAASlB,SAASC,eAAe,uBACjCkB,MAAQnB,SAASC,eAAe,0CAElC,oBAAoBmB,OAAM,WACxB7B,MAAMoB,iBAAkB,EACxBU,YAAYC,YAAa/B,MAAMgC,oBAGnCC,UAAUC,aACLC,aAAa,CAACT,OAAO,EAAMU,OAAO,IAClCC,MAAMC,SACHZ,MAAMa,UAAYD,OAClBZ,MAAMc,OACNvC,iBAAkB,CAAlB,IAEHwC,OAAOC,MACJxC,OAAOC,QAAQwC,mCAA4BD,eAY7CX,YAAc,QAChB/B,MAAM4C,GAAKC,aAAaC,QAAQ,aAE5B9C,MAAMoB,iBAAmBpB,MAAM4C,GAAI,OAC7BG,QAAUpB,OAAOqB,WAAW,SAC9B3B,OAASE,OAAQ,CACjBI,OAAON,MAAQA,MACfM,OAAOJ,OAASA,OAChBwB,QAAQE,UAAUvB,MAAO,EAAG,EAAGL,MAAOE,cAEhC2B,KAAOvB,OAAOwB,UAAU,aAC9BvB,MAAMwB,aAAa,MAAOF,MAC1BlD,MAAMqD,cAAgBH,WAEhBI,aAAe,wCACfC,OAAS,UACCvD,MAAMiB,mBACLjB,MAAM4C,UACT5C,MAAMmB,kBACF+B,MAGZM,QAAU,CACZzC,WAAYuC,aACZtC,KAAMuC,QAGVrD,OAAOC,QAAQC,IAAImD,sBAEdzC,KAAK,CAAC0C,UAAU,GAAGC,MAAMP,OAC1BhD,OAAOC,QAAQC,IAAI8C,MACU,IAAzBA,KAAKQ,SAAS9C,QACVc,OACAiC,aAAaC,gBAAgB,CACzBC,QAAS,gDAAiDC,KAAM,aAI7EC,MAAMrB,MACLxC,OAAOC,QAAQC,IAAI,qBACnBF,OAAOC,QAAQC,IAAIsC,YAjDhB,YACTK,QAAUpB,OAAOqB,WAAW,MAClCD,QAAQiB,UAAY,OACpBjB,QAAQkB,SAAS,EAAG,EAAGtC,OAAON,MAAOM,OAAOJ,cAEtC2B,KAAOvB,OAAOwB,UAAU,aAC9BvB,MAAMwB,aAAa,MAAOF,OA8ClBgB,KAKRxC,OACAA,MAAMyC,iBACF,WACA,KACS3C,YACGxB,MAAMoB,kBACNC,MAAQ,KAEZE,OAASG,MAAM0C,aAAe1C,MAAM2C,WAAahD,OAE7CiD,MAAM/C,UACNA,OAASF,OAAS,EAAI,IAG1BK,MAAM0B,aAAa,QAAS/B,OAC5BK,MAAM0B,aAAa,SAAU7B,QAC7BI,OAAOyB,aAAa,QAAS/B,OAC7BM,OAAOyB,aAAa,SAAU7B,QAC9BC,WAAY,MAGpB"}